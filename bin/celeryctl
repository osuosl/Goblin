#!/bin/sh

host=`hostname -s`
base=/vol/goblin

start(){
	. $base/bin/goblin
	celeryd --autoscale=50,5 --loglevel=INFO -Q optin -n $host &
	echo celeryd started
	echo tail -f /vol/goblin/var/celery.log
}

stop(){
	pkill -f celeryd -u dennis
	echo -n "Stopping celeryd .."
	if status; then
		while status; do
			sleep 1
			echo -n .
		done
	fi
	echo celeryd stopped
}

status(){
	ps -elf | grep -v grep | grep dennis | grep -q celeryd
	if [ $? == 0 ]; then
		echo celeryd is running
		return 0
	else:  
		echo celeryd is not running
		return 1
	fi
}

restart(){
	if status; then
		stop
		while status; do
			sleep 1
		done
		start
	else
		start
	fi
}

cmd=$1
if [ "$cmd" = "start" ]; then
	start
elif [ "$cmd" = "stop" ]; then
	stop
elif [ "$cmd" = "restart" ]; then
	restart
elif [ "$cmd" = "status" ]; then
	status
else
	echo "Error: expecting one of -- start, stop, status, or restart"
fi

